<html>
<head>
<script src="./node_modules/tlx/dist/tlx.js"></script>
<script>

/*(() => {
	Object.defineProperty(HTMLSelectElement.prototype,"value",
		{
			enumerable:true,
			configurable:true,
			get:function() {
				if(this.attributes.source) {
					this.value = Function(`return ${this.attributes.source.value}`)().call(this);
					return value;
				}
				value = "";
				for(const option of this.options) {
					if(option.selected) {
						value = value ? `${value},${option.value}` : option.value;
					}
				}
				return value;
			},
			set:function(newValue) {
				value = newValue+"";
				const values = value.split(",");
				for(const option of this.options) {
					if(values.some(optionvalue => optionvalue==value)) option.selected = true;
				}
				if(this.attributes.sink) {
					Function(`return ${this.attributes.source.value}`)().call(this,value);
				}
			}
		});
})();

(() => {
	let value;
	Object.defineProperty(HTMLInputElement.prototype,"value",
		{
			enumerable:true,
			configurable:true,
			get:function() {
				if(this.attributes.source) {
					this.value = Function(`return ${this.attributes.source.value}`)().call(this);
				}
				return value===undefined ? "" : value;
			},
			set:function(newValue) {
				if(this.attributes.sink) {
					Function(`return ${this.attributes.source.value}`)().call(this,newValue);
				}
				value = newValue===undefined ? "" : newValue+"";
			}
		});
})();*/


function stdev(values) {
  const avg = average(values),
  	squareDiffs = values.map(function(value){
	    const diff = value - avg;
	    return diff * diff;
	  });
  return Math.sqrt(average(squareDiffs));
}

function average(data) {
  return data.reduce((sum, value) => sum + value,0) / data.length;
}

const DecisionSpaceSelector = (state, actions) => {
	const participants = Object.keys(state.participants).sort();
	participants.unshift("Summary");
	return tlx.h("div",
			{},
			[
				tlx.h("select",
					{
						style: "font-family:Helvetica;font-size:10px;",
						onchange: (event) => actions.select(event.target.value)
					},
					participants.map(participant => tlx.h("option",{selected: participant===state.selected ? true : false},[participant]))
				)
			]);	
}

const DecisionSpaceView = (state, actions) => {
	const schema = state.appraisalCtor.schema,
		keys = Object.keys(schema),
		width = ((1/keys.length)*100)+"%",
		id = state.selected,
		participants = state.participants;
	return tlx.h("table",
		{style:"font-size:14px"},
		[
			tlx.h("thead",
				{},
				[
					tlx.h("tr",
						{
							style: "height:75px"
						},
						keys.map((key,i) => {
							const spec = schema[key];
							if(!spec.hidden) {
								if(i>0) {
									return tlx.h("th",{width,title:spec.title||spec.compute||key,style:"transform:rotate(-45deg);" + (spec.style||"")},[spec.label||key])
								}
								return tlx.h("th",{width});
							}
						})	
					),
					tlx.h("tr",
						{},
						keys.map((key,i) => {
							const spec = schema[key];
							if(!spec.hidden) {
								if(i===0) {
									return tlx.h("th",{width},["Source/Importance"]);
								}
								if(spec.type==="number") {
									const weight = id && participants[id] && !isNaN(participants[id].weights[cname]) ? participants[id].weights[cname] : (isNaN(spec.weight) ? 0.60 : spec.weight);
									let selected = "Medium";
									const options = {
										"Very High": 5,
										"High": 4,
										"Medium": 3,
										"Low": 2,
										"Very Low": 1,
										"Irrelevant": 0
									}
									for(const key in options) {
										if(options[key]==weight) {
											selected = key;
											break;
										}
									}
									return tlx.h("th",
											{width},
											[
												tlx.h("select",
													{style:"width:100%;font-family:Helvetica;font-size:10px;"},
													Object.keys(options).map(key => tlx.h("option",{value:options[key],selected:key===selected},[key]))
												)
											])
								}
								return tlx.h("th",{width});
							}
						})
					)
				]
			),
			// body here
		]);	
}

class DecisionSpace {
	constructor(config,appraisalCtor,factors,weights) {
		this.options = {};
		this.participants = {};
		this.appraisalCtor = appraisalCtor;
		this.selected = "Summary";
		if(factors) this.factors = factors;
		if(weights) this.weights = weights;
	}
	addOption(config) {
		const option = this.options[config.name] = new Option(config,this.appraisalCtor);
		if(this.factors && !option.factors) option.factors = this.factors;
		if(this.weights && !option.weights) option.weights = this.weights;
		Object.defineProperty(option,"space",{enumerable:false,configurable:true,writable:true,value:this});
		return option;
	}
	addParticipant(id,properties) {
		this.participants[id] || (this.participants[id]={weights:{}});
		Object.assign(this.participants[id],properties);
	}
	select(id="Summary") {
		tlx.app(this,this,DecisionSpaceSelector,document.getElementById("select"));
		tlx.app(this,this,DecisionSpaceView,document.getElementById("decisionspace"));
		return {selected:id};
	}
}

class Option {
	constructor(config={},appraisalCtor,factors,weights) {
		Object.assign(this,config);
		this.appraisalCtor = appraisalCtor;
		this.appraisals = {};
		this.summary = {};
		if(factors) this.factors = factors;
		if(weights) this.weights = weights;
	}
	addAppraisal(config={},weights) {
		const appraisal = this.appraisals[config.source] = new ProjectAppraisal(config,weights);
		appraisal.option = this;
		if(weights) {
			this.space.addParticipant(config.source,{weights});
		} else {
			this.space.addParticipant(config.source);
		}
		this.summarize();
	}
	render(id) {
		let html = "";
		if(id==="Summary") {
			html = this.renderSummary();
		} else {
			for(const source in this.appraisals) {
				if(!id || source===id) {
					html += this.appraisals[source].renderRow();
				}
			}
		}
		return html;
	}
	renderSummary() {
		let html = "<tr>",
			keys = Object.keys(this.appraisalCtor.schema);
		keys.forEach(key => {
			const spec = this.appraisalCtor.schema[key];
			if(!spec.hidden) {
				let title, value, red = 0, green = 0, blue = 0, style = "normal", weight = "normal";
				if(this.summary[key]) {
					const min = this.summary[key].min.toFixed(2),
						max = this.summary[key].max.toFixed(2),
						stdev = this.summary[key].stdev;
					value = this.summary[key].weightedAvg.toFixed(2),
					title = `min:${min} stdev:${stdev} max:${max}`;
					if(stdev>=1) { red = 128+64; green = 0; blue = 0; style = "italic"; weight = "bold"; }
					else if(stdev>=.5) { red = 252; green = 70; blue = 0; weight = "bold"; }
					else { red = 76; green = 128+64; blue = 23; }
				} else if(key==="project"){
					title = this.description;
					value = this.name;
				} else if(key==="source") {
					title = "source";
					value = "Summary";
				} else if(key==="sponsor") {
					title = "sponsor";
					value = this.sponsor;
				}
				const input = `<input id="${key}" value="${value!==undefined ? value : ''}" style="width:100%;font-family:Helvetica;font-size:10px;font-style:${style};font-weight:${weight};color:rgb(${red},${green},${blue})" ${spec.compute||spec.disabled ? "disabled" : ""}></input>`;
				html += `<td title="${title}">${input}</td>`;		
			}
		});
		html += "</tr>";
		return html;
	}
	summarize() {
		this.summary = {};
		const sources = Object.keys(this.appraisals),
			count = sources.length;
		sources.forEach(source => {
			const appraisal = this.appraisals[source];
			Object.keys(appraisal).forEach(key => {
				const value = appraisal[key],
					type = typeof(value);
				if(type==="number") {
					this.summarizeKey(count,key,value,this.weights);
				}
			});
		});
		const factors = this.factors || Object.keys(this.summary);
		this.weight = factors.reduce((accum,factor) => accum += (this.summary[factor].weightedAvg * (!this.weights || isNaN(this.weights[factor]) ? 1 : this.weights[factor])),0)/factors.length;
	}
	summarizeKey(count,key,value,weights={}) {
		this.summary[key]!==undefined || (this.summary[key] = {min:Infinity,sum:0,weightSum:0,max:-Infinity,values:[]});
		this.summary[key].min = Math.min(this.summary[key].min,value);
		this.summary[key].sum += value;
		this.summary[key].weightSum += isNaN(weights[key]) ? 1 : weights[key];
		this.summary[key].avg = this.summary[key].sum / count;
		this.summary[key].weightAvg = this.summary[key].weightSum / count;
		this.summary[key].weightedAvg = this.summary[key].avg * this.summary[key].weightAvg; 
		this.summary[key].max = Math.max(this.summary[key].max,value);
		this.summary[key].values.push(value);
		this.summary[key].stdev = stdev(this.summary[key].values);
	}
}

function Appraisal(f) {
	this.data = {};
	this.ctor = f;
	for(const key in f.schema) {
		const spec = f.schema[key],
			type = typeof(spec.default);
		if(!spec.type && spec.default!=null && type!=="function") spec.type = type;
		this.data[key] || (this.data[key] = {});
		const set = function(value) {
				this.data[key].value = value; 
			},
			get = function() {
				const spec = f.schema[key];
				let value;
				if(spec.compute) {
					value = Function("scope",`with(scope) { return ${spec.compute} }`)(this);
				} else {
					value = this.data[key] && this.data[key].value!==undefined  ?  this.data[key].value : (typeof(spec.default)==="function" ? spec.default.call(this) : spec.default); 
				}
				try {
					value = JSON.parse(value);
				} catch(e) {
					;
				}
				if(typeof(value)==="number") {
					const weight = (!this.data[key] || isNaN(this.data[key].weight) ? (isNaN(spec.weight) ? 1 : spec.weight) : this.data[key].weight);
					return value * weight;
				}
				return value;
			};
		Object.defineProperty(this,key,{enumerable:true,configurable:true,get,set})
	};
}

Appraisal.prototype.renderRow = function() {
	let html = "<tr>",
		keys = Object.keys(this.ctor.schema);
	keys.forEach(key => {
		const spec = this.ctor.schema[key],
			value = this.data[key] && this.data[key].value!==undefined 
			 	?  this.data[key].value 
			 	: (spec.compute ? 
			 			Function("scope",`with(scope) { return ${spec.compute} }`)(this) 
			 			: (this.data[key].value=(typeof(spec.default)==="function" ? spec.default.call(this) : spec.default)));
		let title = spec.title||spec.compute||(value!==undefined ? value : "");
		if(typeof(title)==="function") {
			title = title.call(this);
		}
		if(!spec.hidden) {
			let input;
			if(spec.options) {
				let options = "";
				for(let option of spec.options) {
					let optionvalue = option;
					if(Array.isArray(option)) {
						optionvalue = option[0];
						option = option[1];
					}
					const selected = optionvalue==value ? "selected" : "";
					options += `<option value="${optionvalue}" ${selected}>${option}</option>`;
				}
				input = `<select style="width:100%;font-family:Helvetica;font-size:10px;">${options}</select>`;
			} else {
				input = `<input id="${key}" value="${value!==undefined ? (typeof(value)==='number' ? value.toFixed(2) : value) : ''}" style="width:100%;font-family:Helvetica;font-size:10px;" ${spec.compute||spec.disabled ? "disabled" : ""}></input>`;
			}
			html += `<td title="${title}">${input}</td>`;			
		}
	});
	html += "</tr>";
	return html;
}
Appraisal.extend = function(config) {
	const f = function(values,weights) {
		Appraisal.call(this,f);
		const data = this.data;
		for(const vname in values) {
			this[vname] = values[vname];
		}
		for(const vname in weights) {
			data[vname] || (data[vname] = {});
			data[vname].weight = weights[vname];
		}
	}
	f.schema = Object.assign({},config);
	f.prototype = Object.create(Appraisal.prototype);
	return f;
}

const ProjectAppraisal = Appraisal.extend(
		{
			source: {disabled:true},
			project: {compute:"option.name", label:"Project", title:function() { return this.option.description; }},
			sponsor: {compute:"option.sponsor", label:"Sponsor", title:function() { return this.option.sponsor; }},
			revenue: {label:"Revenue",title:"How much revenue could be associated with the effort?",default: 0},
			cost: {default: 0, label:"Cost"},
			brand:{default: 0, label:"Brand Value", options:[[5,"Very High"],[4,"High"],[3,"Moderate"],[2,"Low"],[1,"Very Low"],[0,"None"]]},
			timeliness:{default: 3, label:"Time To Value", options:[[5,"< 6 Months"],[4,"< 1 Year"],[3,"< 18 Months"],[2,"< 2 Years"],[1,"2+ Years"]]},
			value:{compute:"(revenue - cost) * brand * timeliness", type:"number", label:"VALUE", style:"font-style:italic"},
			passion:{default: 0, label:"Organization Passion", options:[[5,"Very High"],[4,"High"],[3,"Moderate"],[2,"Low"],[1,"Very Low"]]},
			market:{default: 0,label:"Market Pressures", options:[[5,"Very High"],[4,"High"],[3,"Moderate"],[2,"Low"],[1,"Very Low"],[0,"None"]]},
			operationalStability: {default: 0, label:"Operational Stability", options:[[5,"Very Important"],[4,"Important"],[3,"Moderate Importance"],[2,"Low Importance"],[1,"Very Low Importance"],[0,"No Impact"]]},
			compliance:{default: 0, label:"Compliance Needs", options:[[5,"Very High"],[4,"High"],[3,"Moderate"],[2,"Low"],[1,"Very Low"],[0,"None"]]},
			motivators:{compute:"(passion + market + compliance + operationalStability)/4", type:"number", label:"MOTIVATORS", style:"font-style:italic"},
			capability:{default: 0, label:"Know How", options:[[5,"Very High"],[4,"High"],[3,"Moderate"],[2,"Low"],[1,"Very Low"],[0,"None"]]}, // knowledge, training, support
			capacity:{default: 0, label:"Resource Availability", options:[[5,"Very High"],[4,"High"],[3,"Moderate"],[2,"Low"],[1,"Very Low"],[0,"None"]]},
			execution:{compute:"(capability + capacity)/2", type:"number", label:"EXECUTION ABILITY", style:"font-style:italic"},
			score:{compute:"(value + motivators + execution)/3", label:"SCORE", style:"font-style:italic"}
		});

</script>

<script>
const ds = new DecisionSpace({name:"s1"},ProjectAppraisal,["value","motivators","execution"]),
	o1 = ds.addOption({name:"p1",sponsor:"joe@msmary.edu",description:"A realy big project"}),
	o2 = ds.addOption({name:"p2"});

o1.addAppraisal({source:"syblackwell@msmary.edu",revenue:10,cost:5,brand:5,passion:5,market:5,compliance:5,capability:5,capacity:5});
o1.addAppraisal({source:"laird@msmary.edu",revenue:10,cost:5,brand:2,passion:2,market:5,compliance:2,capability:3,capacity:5});

o2.addAppraisal({source:"syblackwell@msmary.edu",revenue:10,cost:5,brand:5,passion:5,market:5,compliance:5,capability:5,capacity:5});
o2.addAppraisal({source:"laird@msmary.edu",revenue:10,cost:5,brand:5,passion:5,market:5,compliance:5,capability:5,capacity:5},{brand:2});

</script>
</head>
<body>
<div id="select"></div>
<div id="decisionspace"></div>
</body>
<script>
ds.select("Summary");
</script>
</html>